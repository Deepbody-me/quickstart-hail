AWSTemplateFormatVersion: "2010-09-09"
Description: "AWS Hail Quickstart"

Parameters:

  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Default: "aws-quickstart"
    Description: "S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Type: "String"

  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Default: "quickstart-aws-hail/"
    Description: "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Type: "String"

  pKmsEbsArn:
    Description: "Optional - If region level EBS encryption is enabled specify the full key ARN.  Otherwise, leave blank.  This does NOT automatically encrypt your AMI."
    Default: ""
    Type: "String"

  pS3packerZipLocation:
    Default: "ami/packer.zip"
    Description: "Required - S3 Key where you will upload the Packer Zip for new AMI builds in the Hail Bucket."
    Type: "String"

  pHailBucket:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    Description: "Required - Contains cache, bootstrapping, etc.  S3-SSE encryption at rest."
    Type: "String"

  pLogBucket:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    Description: "Required - Will use S3-SSE encryption at rest."
    Type: "String"

  pSageMakerBucket:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    Description: "Required - SageMaker Jupyter home directories will be sync'd here.  S3-SSE encryption at rest."
    Type: "String"

  pTagEnvironment:
    AllowedValues:
      - "production"
      - "staging"
      - "sandbox"
      - "test"
      - "development"
      - "qa"
      - "dr"
    Default: "development"
    Description: "Optional - Environment type for default resource tagging."
    Type: "String"

  pTagOwner:
    Type: "String"
    Description: "Optional - Owner of the resources.  Person/Department, etc."
    Default: ""

  pVpcId:
    Description: "Required - SageMaker security group is created in this VPC."
    Type: "AWS::EC2::VPC::Id"


Resources:

  core:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/hail-core.yml"
      Parameters:
        pHailBucket: !Ref pHailBucket
        pKmsEbsArn: !Ref pKmsEbsArn
        pLogBucket: !Ref pLogBucket
        pS3packerZipLocation: !Ref pS3packerZipLocation
        pSageMakerBucket: !Ref pSageMakerBucket
        pTagEnvironment: !Ref pTagEnvironment
        pTagOwner: !Ref pTagOwner
        pVpcId: !Ref pVpcId
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
      TimeoutInMinutes: 5